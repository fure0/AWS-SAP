# ☁️ AWS SQS (Simple Queue Service) 핵심 정리

Amazon SQS는 마이크로서비스, 분산 시스템 및 서버리스 애플리케이션을 분리(Decoupling)하고 확장할 수 있게 해주는 완전 관리형 **메시지 대기열 서비스**입니다.

## 1. SQS의 기본 특성

* **서버리스 및 관리형:** 프로비저닝이 필요 없으며, 관리가 간편합니다.
* **보안:** AWS IAM과 완벽하게 통합되어 권한 관리가 가능합니다.
* **서비스 분리(Decoupling):** 구성 요소 간의 의존성을 제거하여 독립적인 확장과 비동기 처리를 지원합니다.
* **메시지 크기 제한:** * 기본 최대 메시지 크기는 **256KB**입니다.
* **대용량 메시지 처리(Extended Client Library):** 256KB~2GB 데이터는 **Amazon S3**에 업로드하고, SQS 메시지에는 해당 S3 객체의 **Key(포인터)**만 담아 전송합니다.



---

## 2. FIFO 대기열 (First-In-First-Out)

* **특징:** 메시지가 보내진 정확한 순서대로 처리됨을 보장합니다. (Exactly-once 처리)
* **처리량 제한:** * **단일 처리:** 초당 최대 300건
* **배칭(Batching) 시:** 초당 최대 3,000건


* **제한 사항:** 표준 대기열에 비해 규모 제한이 있으므로 설계 시 고려가 필요합니다.

---

## 3. Dead Letter Queue (DLQ, 처리 실패 큐)

메시지 처리가 반복적으로 실패할 경우 시스템의 효율성을 저하시키는 '독약 메시지(Poison Pill)'를 격리하는 장치입니다.

* **작동 원리:** 1.  Consumer가 메시지를 읽었으나 **Visibility Timeout(가시성 제한 시간)** 내에 처리하지 못하면 메시지는 대기열로 복귀합니다.
2.  이 과정이 반복되어 **최대 수신 임계값(Maximum Receive Count)**을 초과하면 메시지는 DLQ로 이동합니다.
* **주요 용도:** 디버깅 및 분석. 무엇이 잘못되었는지 파악한 후 코드를 수정할 수 있습니다.
* **Redrive Allow Policy:** DLQ에 쌓인 메시지를 수정 후 다시 **Source Queue(원래 대기열)**로 보내 재처리할 수 있는 기능을 제공합니다.
* **주의 사항:** 표준 큐의 DLQ는 표준 큐여야 하며, FIFO 큐의 DLQ는 FIFO 큐여야 합니다.

---

## 4. 멱등성 (Idempotency)의 중요성

SQS는 "적어도 한 번(At-least-once)" 전달을 목표로 하므로, 동일한 메시지가 두 번 전달될 수 있습니다. 이를 위해 Consumer는 **멱등성**을 갖춰야 합니다.

> **멱등성이란?**
> 동일한 작업을 여러 번 수행하더라도 결과가 단 한 번 수행했을 때와 같은 성질.

* **비멱등성 예시:** SQS 메시지를 받을 때마다 DB에 `INSERT` (행이 계속 늘어남)
* **멱등성 설계 예시:** DynamoDB의 `upsert`(업데이트 또는 삽입) 기능을 사용. 기본 키를 기준으로 데이터를 처리하면 여러 번 써도 결과는 동일함.

---

## 5. Lambda와 SQS 통합 (Event Source Mapping)

* **동작 방식:** Lambda 서비스 내부의 **Event Source Mapper**가 SQS를 폴링(Polling)하여 메시지를 가져온 뒤 Lambda 함수를 호출합니다.
* **최적화:** 비용과 대기 시간을 줄이기 위해 기본적으로 **Long Polling**을 사용합니다.
* **설정 권장값:** * **Batch Size:** 1~10개 사이로 설정 (효율성과 속도 사이의 선택).
* **Visibility Timeout:** Lambda 함수의 **Timeout의 6배**로 설정할 것을 권장 (문서 기준).


* **실패 처리:** * 비동기 호출이 아니므로 Lambda 레벨의 DLQ가 아닌 **SQS 자체의 DLQ**를 설정해야 합니다.
* 또는 **Lambda Destinations**를 사용하여 실패한 이벤트를 SNS나 SQS로 보낼 수 있습니다.



---

## 6. 주요 솔루션 아키텍처: 요청-응답 패턴

시스템의 유연성과 안정성을 극대화하기 위해 다음과 같은 구조를 사용합니다.

1. **Client** → **SQS (Request Queue)** 전송
2. **Worker Process** → Request Queue에서 메시지 읽기 및 작업 수행
3. **Worker Process** → **SQS (Response Queue)**에 결과 전송
4. **Client** → Response Queue에서 결과 확인

* **장점:**
* **독립적 확장:** 요청 측과 처리 측을 개별적으로 확장 가능.
* **결함 허용(Fault-Tolerance):** 특정 워커가 실패해도 다른 워커가 메시지를 가져가 처리함.
* **부하 분산(Load Balancing):** 수평 확장을 통해 요청을 고르게 분산 처리.
