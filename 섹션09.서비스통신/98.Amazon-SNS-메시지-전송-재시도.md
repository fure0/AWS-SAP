## 1. SNS 메시지 전송 재시도 정책 (Delivery Retry Policies)

SNS 주제(Topic)에 메시지가 게시되면, SNS는 구독자(End-point)에게 메시지 배달을 시도합니다. 이때 서버 측 오류로 인해 배달에 실패할 경우, 엔드포인트 유형에 따라 각기 다른 재시도 정책이 적용됩니다.

### A. AWS 관리형 엔드포인트 (AWS Managed Endpoints)

KDF(Firehose), Lambda, SQS와 같은 서비스들은 AWS가 관리하며, 매우 공격적인 재시도 정책을 가집니다.

| 단계 | 설명 | 재시도 횟수 및 간격 |
| --- | --- | --- |
| **Immediate Retry** | 오류 발생 즉시 시도 | 3회 즉시 재시도 |
| **Pre-backoff** | 초기 지연 시도 | 2회 (1초 간격) |
| **Backoff** | 지수 백오프 적용 | 10회 (1~20초 사이 지수적 증가) |
| **Post-backoff** | 장기 지속 시도 | **100,000회** (20초 간격) |
| **합계** | **약 23일 동안 지속** | **총 100,015회 시도** |

### B. HTTP/S 엔드포인트 (Custom Delivery Policy)

사용자가 직접 관리하는 HTTP/S 서버의 경우, 백엔드 서버의 과부하를 방지하기 위해 **사용자 지정 배달 정책**을 설정할 수 있습니다.

* **특징:** 유일하게 재시도 정책을 커스터마이징할 수 있는 메커니즘입니다. (중요!)
* **설정 항목:**
  * 총 재시도 횟수
  * 최소/최대 지연 시간
  * 백오프(Backoff) 알고리즘 방식
  * 스로틀링(Throttling) 정책 (백엔드 보호 목적)



---

## 2. SNS Dead Letter Queue (DLQ)

모든 재시도 정책을 소진했음에도 불구하고 메시지 배달에 최종 실패했을 때, 메시지 유실을 방지하기 위한 보관 장소입니다.

### 핵심 개념: 구독(Subscription)별 설정

가장 중요한 포인트는 DLQ가 **SNS 토픽(Topic)에 설정되는 것이 아니라, 각각의 구독(Subscription)에 설정된다**는 점입니다.

* **작동 방식:**
  1. SNS 토픽에 메시지 도착.
  2. 각 구독(Email, HTTP 등)으로 메시지 전달 시도.
  3. 재시도 정책 실패 시, 해당 구독에 연결된 **SQS DLQ**로 메시지 이동.

* **구독별 독립성:**
  * 이메일 구독 서버에 장애가 나면 이메일용 DLQ에 저장.
  * HTTP 구독 서버에 장애가 나면 HTTP용 DLQ에 저장.
  * 이를 통해 각 구독 환경에 맞는 개별적인 장애 대응 및 메시지 처리가 가능합니다.



### 주의 사항

* **FIFO 토픽:** SNS FIFO 토픽을 사용하는 경우, DLQ 역시 **SQS FIFO 대기열**을 사용해야 합니다.
* **메시지 폐기:** DLQ를 설정하지 않은 상태에서 모든 재시도 횟수를 넘기면 메시지는 영구적으로 삭제됩니다.
