## 1. VPC 엔드포인트 정책 (Endpoint Policies)

VPC 엔드포인트 정책은 엔드포인트를 통해 서비스에 액세스하는 것을 제어하는 **JSON 리소스 기반 정책**입니다.

* **특징:**
  * IAM 사용자 정책이나 서비스 정책(예: SQS 대기열 정책)을 대체하지 않으며, **추가적인 보안 계층** 역할을 합니다.
  * **Principal 요소**를 사용하여 특정 사용자나 역할이 수행할 수 있는 작업(예: `sqs:SendMessage`)을 정의합니다.
  * **한계:** 엔드포인트 수준에서만 적용됩니다. 사용자가 엔드포인트를 거치지 않고 **퍼블릭 라우트**를 통해 서비스에 접근하면 이 정책은 무시됩니다.



---

## 2. 보안 강화 전략 (SQS & S3 예시)

### A. 모든 연결을 VPC 엔드포인트로 강제하기

퍼블릭 우회를 막기 위해 서비스(SQS, S3 등) 자체의 리소스 정책에 **"VPC 엔드포인트를 거치지 않은 연결을 거부(Deny)"**하는 규칙을 추가합니다. 이렇게 하면 모든 트래픽이 엔드포인트 정책의 통제를 받게 됩니다.

### B. S3 버킷 액세스 제한 예시

* **특정 버킷 제한:** 엔드포인트 정책에서 `Resource`를 특정 버킷(`my_secure_bucket`)으로 지정하여, 해당 엔드포인트로는 다른 버킷에 접근할 수 없도록 제한할 수 있습니다.
* **리포지토리 액세스:** EC2 인스턴스가 업데이트를 위해 Amazon Linux 리포지토리(S3 기반)에만 프라이빗하게 접근하도록 설정할 수 있습니다.

---

## 3. 조건부 액세스 제어 (`Condition` 사용)

S3 버킷 정책에 아래의 조건 키를 사용하여 보안을 더욱 정교하게 설계할 수 있습니다.

| 조건 키 | 설명 | 용도 |
| --- | --- | --- |
| **`aws:sourceVpce`** | 특정 VPC 엔드포인트 ID를 지정 | 특정 통로를 통해서만 들어오는 트래픽 허용 |
| **`aws:sourceVpc`** | 특정 VPC ID를 지정 | 여러 엔드포인트가 있더라도 해당 VPC 내부 트래픽이면 허용 |
| **`aws:SourceIp`** | 특정 퍼블릭 IP 주소 지정 | **주의:** 프라이빗 연결에는 적용되지 않으며, 퍼블릭 IP/EIP 액세스 제한 시 사용 |

> **중요:** 프라이빗 네트워크 트래픽을 제한할 때는 `SourceIp` 대신 반드시 `sourceVpce`나 `sourceVpc`를 사용해야 합니다.

---

## 4. 트러블슈팅 가이드 (EC2 → S3 연결 오류 시)

프라이빗 서브넷의 EC2 인스턴스가 S3에 연결되지 않을 때, 다음 단계별 체크리스트를 확인해야 합니다.

1. **EC2 보안 그룹 (Security Group):**
   * 아웃바운드(Outbound) 규칙에서 S3(또는 엔드포인트)로 나가는 트래픽이 허용되어 있는가?

2. **VPC 엔드포인트 게이트웨이 및 정책:**
   * 엔드포인트가 생성되었는가?
   * 엔드포인트 정책이 해당 EC2의 S3 액세스를 허용(Allow)하고 있는가?

3. **라우팅 테이블 (Route Table):**
   * S3로 향하는 트래픽이 VPC 엔드포인트 게이트웨이를 거치도록 경로가 추가되어 있는가? (설정 안 될 경우 연결 불가)

4. **VPC DNS 설정:**
   * `DNS Resolution`이 사용 설정(Enabled)되어 있는가?

5. **S3 버킷 정책 (Bucket Policy):**
   * 버킷 정책에서 해당 EC2나 엔드포인트의 접근을 거부(Deny)하고 있지는 않은가?

6. **IAM 역할 (IAM Role):**
   * EC2 인스턴스에 할당된 IAM 역할에 S3 권한이 적절히 부여되었는가?