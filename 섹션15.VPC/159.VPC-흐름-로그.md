# 🌐 AWS VPC 플로우 로그 (VPC Flow Logs) 완벽 정리

VPC 플로우 로그는 VPC 네트워크 인터페이스(ENI)에서 전송되는 **IP 트래픽 정보를 캡처**하여 모니터링 및 트러블슈팅에 활용하는 서비스입니다.

## 1. 기본 개념 및 특징

* **캡처 범위:** VPC 수준, 서브넷 수준, 그리고 개별 ENI 수준에서 설정 가능합니다.
* **지원 리소스:** EC2뿐만 아니라 ELB, RDS, ElastiCache, Redshift, WorkSpaces, NAT Gateway, Transit Gateway 등 **관리형 인터페이스**의 트래픽도 캡처합니다.
* **데이터 저장소:** 캡처된 로그는 **Amazon S3** 또는 **CloudWatch Logs**로 전송됩니다.

### 📊 플로우 로그 데이터 구성 (메타데이터)

플로우 로그는 실제 패킷의 내용이 아닌 **메타데이터**를 포함합니다.

* `Version`, `Account-ID`, `Interface-ID`
* **Source/Destination IP & Port:** 문제 IP 식별 및 공격 탐지
* **Protocol:** 어떤 통신 프로토콜인지 확인
* **Packets/Bytes:** 트래픽 양 분석
* **Action:** `ACCEPT`(허용) 또는 `REJECT`(거부) -> 보안 그룹/NACL 설정 확인의 핵심
* **Log Status:** 로그 수집 상태

---

## 2. 보안 그룹(SG) vs NACL 트러블슈팅

로그의 **Action** 필드를 분석하여 네트워크 차단 지점을 파악할 수 있습니다.

> **핵심 원리:** 보안 그룹은 **Stateful**(상태 유지), NACL은 **Stateless**(상태 비저장)입니다.

### 📥 인바운드 트래픽 분석

| 현상 | 원인 분석 |
| --- | --- |
| **인바운드 REJECT** | NACL 또는 보안 그룹(SG)에서 요청을 거부함. |
| **인바운드 ACCEPT / 아웃바운드 REJECT** | **NACL 문제임.** (SG는 Stateful이라 인바운드가 허용되면 아웃바운드도 자동 허용되지만, NACL은 나가는 길도 따로 열어줘야 하기 때문) |

### 📤 아웃바운드 트래픽 분석

| 현상 | 원인 분석 |
| --- | --- |
| **아웃바운드 REJECT** | NACL 또는 보안 그룹(SG)에서 요청을 거부함. |
| **아웃바운드 ACCEPT / 인바운드 REJECT** | **NACL 문제임.** (SG는 아웃바운드가 허용되면 들어오는 응답도 자동 허용됨) |

---

## 3. 로그 분석 및 시각화 도구

플로우 로그를 쿼리하고 분석하는 대표적인 방법 두 가지입니다.

1. **Amazon Athena (S3 연동):** S3에 저장된 대량의 로그를 SQL 쿼리로 분석할 때 가장 효율적입니다. (QuickSight로 시각화 가능)
2. **CloudWatch Logs Insights:** 스트리밍 분석 및 실시간 로그 확인에 적합합니다.

### 🛠 활용 시나리오

* **Contributor Insights:** 가장 많은 트래픽을 유발하는 상위 10개 IP 식별.
* **Metric Filters & Alarms:** SSH(22번)나 RDP(3389번) 접속 시도가 비정상적으로 많을 경우 SNS 알림 발송.

---

## 4. 심화 사례: NAT Gateway와 플로우 로그

**Q: NAT 게이트웨이는 인바운드 접속을 차단하는데, 왜 플로우 로그에는 외부 IP의 접속이 'ACCEPT'로 찍힐까요?**

* **이유:** 보안 그룹이나 NACL에서 해당 트래픽을 허용한다면, 일단 인터페이스(ENI)까지는 도달하기 때문에 `ACCEPT`로 기록됩니다.
* **실제 동작:** 트래픽이 NAT 게이트웨이 장치 내부로 들어오면, 유효하지 않은 인바운드 요청은 거기서 드롭(Drop)됩니다.
* **검증 방법 (CloudWatch Logs Insights 쿼리):**
  * VPC 내부 대역을 대상(`dstAddr`)으로 필터링하고 공인 IP를 소스(`srcAddr`)로 하여 전송된 바이트를 합산해 봅니다.
  * NAT 게이트웨이의 사설 IP로 향하는 트래픽만 보이고 그 이상의 내부 연결이 없다면, NAT 게이트웨이가 정상적으로 원치 않는 트래픽을 차단하고 있는 것입니다.
