## 1. AWS Site-to-Site VPN 개요

회사 데이터 센터(온프레미스)와 AWS VPC를 **공개 인터넷**을 통해 암호화된 상태로 연결하는 서비스입니다. 사설 IP를 사용하여 양측 리소스에 직접 접근할 수 있게 해줍니다.

### **주요 구성 요소**

* **가상 사설 게이트웨이 (VGW):** VPC 측에 생성하여 부착하는 리소스 (VPC 수준).
* **고객 게이트웨이 (CGW):** 온프레미스 측의 VPN 장비(하드웨어/소프트웨어)를 의미하며, 공인 IP가 필요함.
* **VPN 터널:** VGW와 CGW 사이에 생성되는 통로. 가용성을 위해 **2개의 터널**이 생성되며 **IPsec**으로 암호화됨.
* **가속화:** 성능 향상을 위해 **AWS Global Accelerator**를 사용하여 전 세계 네트워크를 타고 빠르게 연결 가능.

---

## 2. 라우팅 설정 (Route Propagation)

양측 네트워크가 통신하려면 서로의 CIDR(IP 대역)을 알아야 합니다.

### **라우팅 방식 비교**

| 방식 | 특징 | 설명 |
| --- | --- | --- |
| **정적 라우팅 (Static)** | 수동 설정 | 관리자가 각 라우트 테이블에 상대방 CIDR과 대상(VGW/CGW)을 직접 입력. |
| **동적 라우팅 (Dynamic)** | 자동 공유 | **BGP(Border Gateway Protocol)**를 사용. ASN(자율 시스템 번호)을 지정하면 라우트 정보를 자동으로 업데이트함. |

---

## 3. 인터넷 아웃바운드 트래픽 흐름 (중요 패턴)

온프레미스와 VPC 간의 연결을 통해 인터넷으로 나가는 트래픽을 제어하는 세 가지 시나리오입니다.

### **① 온프레미스 → AWS NAT Gateway → 인터넷 (불가능)**

* **구조:** 온프레미스 서버 → CGW → VGW → NAT Gateway → IGW → 인터넷.
* **결과:** **작동 안 함.**
* **이유:** NAT Gateway는 VPN이나 Direct Connect에서 들어오는 소스 트래픽을 인터넷으로 전달하지 못하는 제약이 있음.

### **② 온프레미스 → AWS NAT Instance → 인터넷 (가능)**

* **구조:** 온프레미스 서버 → CGW → VGW → NAT Instance → IGW → 인터넷.
* **결과:** **가능.**
* **이유:** 사용자가 직접 관리하는 인스턴스이므로 소프트웨어 레벨에서 라우팅 제어가 가능함.

### **③ AWS VPC → 온프레미스 NAT → 인터넷 (가능)**

* **구조:** VPC 인스턴스 → VGW → CGW → 온프레미스 NAT/방화벽 → 인터넷.
* **결과:** **가능.**
* **이유:** 보안상의 이유로 모든 트래픽을 본사의 패킷 필터링/검사 장비를 거치게 할 때 사용하는 유효한 아키텍처임.

---

## 4. 확장된 VPN 아키텍처

### **VPN CloudHub**

* **개요:** 하나의 VGW에 여러 개의 CGW(지사 네트워크)를 연결하는 허브 앤 스포크(Hub-and-Spoke) 모델.
* **특징:**
* 최대 10개의 CGW 연결 가능.
* 각 지사(예: 뉴욕, LA, 마이애미)가 VGW를 통해 서로 통신 가능.
* Direct Connect의 백업(장애 조치) 용도로 주로 사용됨.



### **다중 VPC 연결 전략 (Shared Services VPC)**

VPC가 많아질수록 각각 VPN을 뚫는 것은 관리상 복잡합니다. 이를 위해 **공유 서비스 VPC** 모델을 활용합니다.

1. **단일 VPN 연결:** 온프레미스와 '공유 서비스 VPC' 사이에만 VPN을 설정.
2. **리소스 복제/프록시:** 온프레미스의 DB나 서비스를 공유 VPC에 복제하거나, 요청을 전달할 프록시 서버를 배치.
3. **VPC Peering:** 다른 모든 VPC(A, B, C)를 공유 VPC와 피어링함.
4. **효과:** VPC 피어링은 전이(Transitive)되지 않지만, 공유 VPC 내의 **프록시나 복제본**을 통해 간접적으로 온프레미스 리소스에 접근 가능하므로 관리가 단순해짐.
