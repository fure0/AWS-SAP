## 1. AWS WAF 개요

* **정의:** Layer 7(HTTP/HTTPS) 계층의 웹 취약점 공격을 방어하는 웹 애플리케이션 방화벽입니다.
* **핵심 차이점:** * **WAF:** L7 웹 취약점(SQL Injection, XSS 등) 방어.
* **Shield:** DDoS 공격 방어.



---

## 2. 배포 가능 서비스 및 위치

WAF는 다양한 AWS 리소스에 배포되어 트래픽을 필터링합니다.

| 배포 대상 | 특징 및 효과 |
| --- | --- |
| **Application Load Balancer (ALB)** | 로컬화된 규칙 적용 |
| **API Gateway** | 리전 또는 엣지 수준에서 실행 |
| **CloudFront** | **전역(Global)** 배포. 모든 엣지 로케이션에서 실행 (S3 웹사이트, 사용자 지정 오리진 보호 시 유용) |
| **AppSync** | GraphQL API 직접 보호 |

---

## 3. Web ACL 및 규칙(Rule) 설정

WAF는 **Web ACL(액세스 제어 목록)**을 정의하여 트래픽을 제어합니다.

### 주요 필터링 기준

* **IP 주소:** 특정 IP 또는 범위 차단/허용
* **HTTP 구성 요소:** 헤더(Header), 바디(Body), URI 문자열 필터링
* **공격 패턴:** SQL 주입(SQLi), 교차 사이트 스크립팅(XSS) 방어
* **사이즈 제한:** 예) 20MB 초과 요청 거부
* **Geo 매치:** 특정 국가 차단 또는 허용
* **발생 속도(Rate-based):** 초당 요청 횟수 제한 (예: 1초에 5회 이상 시 차단)

### 규칙 액션(Action) 종류

1. **Allow:** 트래픽 허용
2. **Block:** 트래픽 차단
3. **Count:** 트래픽을 허용하되 횟수만 기록 (**긍정 오류(False Positive) 탐지 및 규칙 테스트용**)
4. **CAPTCHA:** 클라이언트 측 검증 수행

---

## 4. WAF 관리형 규칙 (Managed Rule Groups)

AWS 및 마켓플레이스 전문가들이 미리 만들어둔 규칙 세트로, 빠르게 보안을 강화할 수 있습니다. (시험 단골 주제)

* **기준선 규칙 (Baseline):** 일반적인 위협 방어 (`CommonRuleSet`, `AdminProtectionRuleSet`)
* **활용 사례별 규칙 (Use-case Specific):** 특정 환경 보호 (`SQL`, `Windows`, `PHP`, `WordPress` 전용 세트)
* **IP 평판 규칙 (IP Reputation):** 악성 IP 리스트 기반 차단 (`AmazonIpReputationList`가 대표적)
* **봇 제어 (Bot Control):** 악의적인 봇 요청 관리 (`BotControlRuleSet`)

---

## 5. 로깅 및 분석 (Logging)

WAF의 로그를 전송하고 분석하는 세 가지 방법입니다.

* **CloudWatch Logs:** 최대 초당 5MB 전송 속도 제한.
* **Amazon S3:** 5분마다 로그 전송.
* **Kinesis Data Firehose:** * **가장 권장되는 방식 (고용량 트래픽 시):** Firehose 쿼터에 의해서만 제한됨.
* **수신처:** S3, Redshift, OpenSearch 등으로 확장 가능.



---

## 6. 고급 아키텍처: 오리진 보안 강화 (CloudFront + ALB)

사용자가 CloudFront를 거치지 않고 ALB에 직접 접근하는 것을 막기 위한 보안 전략입니다.

### 구성 단계

1. **사용자 지정 HTTP 헤더 설정:** CloudFront에서 오리진으로 요청을 보낼 때 특정 헤더(예: `X-Origin-Verify`)와 비밀 문자열을 추가하도록 설정합니다.
2. **ALB WAF 설정:** ALB 앞단에 WAF를 두고, 해당 비밀 헤더가 포함된 요청만 `Allow`하고 나머지는 `Block`하는 규칙을 만듭니다.
3. **보안 자동화 (Secrets Manager + Lambda):** * Secrets Manager에서 비밀 값을 관리합니다.
* Lambda가 주기적으로 비밀 값을 교체(Rotate)합니다.
* CloudFront의 헤더 값과 WAF의 필터링 규칙을 동시에 업데이트하여 보안을 극대화합니다.
