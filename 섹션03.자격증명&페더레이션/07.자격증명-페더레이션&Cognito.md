# 🌐 AWS 자격 증명 페더레이션 (Identity Federation) 요약

## 1. 개요 및 필요성

자격 증명 페더레이션은 **AWS 외부에 있는 사용자**에게 AWS 리소스 액세스 권한을 부여하는 기술입니다.

* **핵심 이점:** AWS 내부에 IAM 사용자를 개별적으로 생성할 필요가 없음 (기존 조직의 디렉터리 활용).
* **주요 사례:**
  * 기업 내 **Active Directory(AD)** 시스템 운영 시.
  * 웹/모바일 앱 사용자가 AWS 리소스에 직접 접근해야 할 때.


* **기본 흐름:** AWS와 자격 증명 제공자(IdP) 간 **신뢰 관계** 설정 → IdP 로그인 → 임시 자격 증명 발급 → AWS 액세스.

---

## 2. SAML 2.0 페더레이션 (표준 방식)

SAML 2.0은 기업용 IdP(ADFS, Okta 등)와 AWS를 연동하는 개방형 표준 프로토콜입니다.

* **동작 방식 (API/CLI 접근):**
1. 사용자가 IdP(포털)에 인증 요청.
2. IdP가 사용자 검증 후 **SAML 어설션(Assertion)** 반환.
3. 사용자는 STS의 `AssumeRoleWithSAML` API를 호출하며 어설션 전달.
4. STS가 검증 후 **임시 보안 자격 증명** 발급.


* **동작 방식 (Console 접근):**
* 위 과정과 유사하나, 마지막에 특수 로그인 URL을 통해 AWS 매니지먼트 콘솔로 바로 리디렉션됩니다.



---

## 3. 사용자 지정 자격 증명 브로커 (Custom Broker)

SAML 2.0을 지원하지 않는 오래된 시스템을 사용할 때 활용하는 방식입니다.

* **특징:** 자격 증명 브로커가 중간에서 "중재자" 역할을 수행합니다.
* **메커니즘:**
1. 사용자가 브로커에 로그인.
2. 브로커가 자체적으로 인증 후, **관리자 권한**으로 STS에 임시 자격 증명 요청 (`AssumeRole` 또는 `GetFederationToken`).
3. 브로커가 받은 자격 증명을 사용자에게 전달.


* **책임:** 브로커가 사용자에게 적절한 IAM 역할을 매핑할 책임을 가집니다.

---

## 4. 웹 자격 증명 페더레이션 (Web Identity Federation)

Amazon, Google, Facebook 같은 타사 소셜 로그인(OIDC)을 이용하는 방식입니다.

### ① Cognito 미사용 (비권장)

* 클라이언트가 IdP에서 토큰을 받아 STS의 `AssumeRoleWithWebIdentity` API를 직접 호출하여 자격 증명을 얻습니다. 보안 및 관리 측면에서 현재는 권장되지 않습니다.

### ② Amazon Cognito 사용 (권장)

* **토큰 자동 판매기(Token Vending Machine)** 역할을 수행합니다.
* **장점:** * **익명 사용자** 지원.
* MFA(다중 인증) 지원 및 기기 간 데이터 동기화 가능.


* **동작 흐름:** 1. IdP 로그인 → 2. Cognito 토큰으로 교환 → 3. STS를 통해 AWS 임시 자격 증명 획득.

---

## 5. IAM 정책 변수를 활용한 제한

페더레이션 사용 시에도 **최소 권한의 원칙**을 지키기 위해 정책 변수를 사용합니다.

* **활용 예시:** 사용자가 자신의 ID와 일치하는 S3 폴더(접두사)에만 접근 가능하도록 설정.
* **주요 변수:**
* `cognito-identity.amazonaws.com:sub` (Cognito 사용자 식별자)
* `amazon.com:user_id` (아마존 로그인 ID)



---

## 6. 요약 및 비교

| 유형 | 자격 증명 제공자(IdP) | 핵심 API / 서비스 | 비고 |
| --- | --- | --- | --- |
| **SAML 2.0** | ADFS, Okta, PingFed | `AssumeRoleWithSAML` | 기업용 표준 방식 |
| **Custom Broker** | 비표준 IdP | `GetFederationToken` | 직접 개발 필요 (Legacy) |
| **Web Identity** | Google, FB, Amazon | Amazon Cognito | 모바일/웹 앱 최적화 |
| **AWS SSO** | AWS IAM Identity Center | - | 최신 세대 관리형 서비스 |
