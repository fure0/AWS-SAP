# 🌐 AWS STS (Security Token Service) 완벽 정리

## 1. STS란 무엇인가?

STS는 사용자에게 AWS 리소스에 대한 **임시 보안 자격 증명**을 생성하여 제공하는 웹 서비스입니다.

* **주요 특징**:
  * **임시성**: 자격 증명의 유효 기간은 **15분에서 12시간** 사이입니다.
  * **최소 권한 원칙**: 사용자가 원래 가진 권한을 잠시 포기하고, 특정 역할(Role)에 할당된 권한만 갖게 됩니다.
  * **보안 강화**: 장기 자격 증명(Access Key)을 노출하지 않고 안전하게 리소스에 접근할 수 있습니다.



---

## 2. STS 작동 방식 (AssumeRole)

1. **역할 정의**: 계정 내 또는 타 계정에 IAM Role을 생성합니다.
2. **신뢰 관계 설정**: 어떤 Principal(사용자, 서비스 등)이 이 역할을 맡을 수 있는지 정의합니다.
3. **AssumeRole 호출**: 사용자가 STS에 `AssumeRole` API를 호출합니다.
4. **임시 자격 증명 발급**: STS는 권한 확인 후 임시 보안 자격 증명을 반환합니다.
5. **리소스 접근**: 발급받은 토큰을 사용하여 대상 리소스에 액세스합니다.

---

## 3. 주요 활용 사례

* **교차 계정 액세스 (Cross-Account Access)**: 내가 보유한 다른 AWS 계정이나 제3자의 계정 리소스에 접근할 때 사용합니다.
* **AWS 서비스 권한 부여**: EC2, Lambda 등 AWS 서비스가 다른 리소스에 접근할 수 있도록 역할을 부여합니다.
* **자격 증명 페더레이션 (Federation)**: 외부 ID 공급자(IdP)를 통해 로그인한 사용자에게 AWS 접근 권한을 부여합니다.
* **보안 감사 및 취소**: `AWSRevokeOlderSessions` 정책 등을 통해 활성화된 세션을 강제로 종료하거나 특정 시간 이전의 토큰을 무효화할 수 있습니다.

---

## 4. 제3자 계정 액세스와 "외부 ID(External ID)"

신뢰 구역(내 조직) 외부의 제3자(파트너사, 컨설팅 등)에게 권한을 줄 때 보안을 강화하는 장치입니다.

### 🚨 혼동된 대리인(Confused Deputy) 문제

* **상황**: 제3자 서비스가 여러 고객의 계정을 관리할 때 발생합니다.
* **문제**: 공격자가 자신의 계정인 것처럼 속여서 다른 고객의 역할 ARN을 제3자 서비스에 제공하면, 제3자 서비스가 의도치 않게 타인의 계정을 조작할 수 있습니다.

### ✅ 외부 ID를 통한 해결

* **해결책**: 역할 생성 시 **External ID**(공유 비밀번호 역할)를 필수로 설정합니다.
* **효과**: 제3자 서비스가 우리 계정에 접근할 때 반드시 우리가 지정한 외부 ID를 함께 제출해야 하므로, 공격자가 ARN만 안다고 해서 접근할 수 없게 방어합니다.

---

## 5. STS 세션 태그 (Session Tags)

`AssumeRole` 시 사용자 정보를 태그(`Key=Value`) 형태로 전달하는 기능입니다.

* **예시**: 사용자가 `Department=HR` 태그를 가지고 역할을 맡으면, S3 버킷 정책에서 이 태그가 일치하는 경우에만 접근을 허용하는 식의 **속성 기반 액세스 제어(ABAC)**가 가능해집니다.

---

## 6. 핵심 STS API 요약

| API 명칭 | 주요 용도 |
| --- | --- |
| **AssumeRole** | 동일/교차 계정 내 역할을 맡을 때 사용하는 가장 기본 API |
| **AssumeRoleWithSAML** | 기업 내 SAML 기반 IdP를 통해 로그인한 경우 자격 증명 획득 |
| **AssumeRoleWithWebIdentity** | 웹 IdP(Google, FB, Cognito 등)를 통한 로그인 시 사용 (Cognito 권장) |
| **GetSessionToken** | MFA(다요소 인증)를 사용하는 사용자의 임시 자격 증명 획득 |
| **GetFederationToken** | 프록시 어플리케이션 등을 통해 커스텀 페더레이션 구현 시 사용 |
