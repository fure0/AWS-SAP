# 🚀 AWS CodeDeploy 핵심 요약 (SAP 대비)

AWS CodeDeploy는 EC2, ASG, Lambda, ECS 등 다양한 컴퓨팅 서비스에 애플리케이션 배포를 자동화하는 **관리형 배포 서비스**입니다.

## 1. EC2 인스턴스 배포 (In-place)

기존에 실행 중인 인스턴스의 코드를 직접 교체하는 방식입니다.

* **작동 원리:** 각 인스턴스에 설치된 **CodeDeploy Agent**가 배포를 수행합니다.
* **설정 파일:** `appspec.yml` 파일을 통해 배포 절차를 정의합니다.
* **배포 전략:** 롤아웃 속도를 조절할 수 있습니다 (예: `HalfAtATime`, `OneAtAtTime`).
* **특징:**
  * 새로운 인스턴스를 생성하지 않음 (**In-place Update**).
  * **Hooks:** 각 배포 단계별로 스크립트를 실행하여 정상 작동 여부를 검증할 수 있습니다.
  * 배포 중 일부 인스턴스가 오프라인이 될 수 있어 가용량(Capacity)이 일시적으로 줄어들 수 있습니다.



---

## 2. Auto Scaling Group (ASG) 배포

ASG 환경에서는 두 가지 방식을 선택할 수 있습니다.

| 방식 | 설명 |
| --- | --- |
| **In-place** | 기존 ASG 내 인스턴스들을 순차적으로 업데이트합니다. 배포 중 ASG가 스케일 아웃하면 CodeDeploy가 새 인스턴스에도 자동으로 코드를 배포합니다. |
| **Blue/Green** | **새로운 ASG**를 생성하여 V2를 배포한 뒤, 로드 밸런서(ALB)의 트래픽을 새 그룹으로 전환합니다. 이전 인스턴스 유지 기간을 설정할 수 있어 안정적입니다. |

---

## 3. AWS Lambda 배포

Lambda 배포 시에는 **람다 별칭(Alias)**의 트래픽 전환 기능을 활용합니다.

* **트래픽 이동:** V1과 V2 사이에서 트래픽을 점진적으로 이동시킵니다 (Linear 또는 Canary).
* **검증 후크 (Hooks):**
  * **Pre-Traffic Hook:** 트래픽 이동 전, V2 함수가 정상인지 테스트 람다를 실행합니다.
  * **Post-Traffic Hook:** 트래픽 이동 완료 후 최종 테스트를 수행합니다.

* **롤백:** CloudWatch 알람과 연동하여 오류 발생 시 즉시 V1으로 **자동 롤백**합니다.
* **SAM 통합:** AWS SAM을 사용하면 CodeDeploy 기반 배포가 기본적으로 적용됩니다.

---

## 4. Amazon ECS 배포

ECS 및 Fargate 환경에서는 **Blue/Green 배포**가 핵심입니다.

* **설정 위치:** CodeDeploy 콘솔이 아닌 **ECS 서비스 정의(Service Definition)** 단계에서 설정합니다.
* **작동 프로세스:**
  1. 새로운 **태스크 세트(Task Set)**를 생성 (V2).
  2. ALB의 트래픽을 새로운 태스크 세트로 리라우팅합니다.
  3. **대기 시간(Wait Time):** 설정된 시간(예: 5분) 동안 안정성을 모니터링합니다.
  4. 문제가 없으면 이전 태스크 세트(V1)를 종료합니다.

* **카나리(Canary) 전략:** 예로 10% 트래픽만 5분간 먼저 흘려보낸 뒤 전체 전환하는 방식이 가능합니다.

---

## 💡 시험 핵심 포인트 (Summary)

> 1. **EC2/ASG**는 `appspec.yml`과 **에이전트**가 필수입니다.
> 2. **Lambda**는 **Alias(별칭)**를 통한 트래픽 쉐이핑과 **Pre/Post Hook**이 중요합니다.
> 3. **ECS**는 서비스 정의 내에서 Blue/Green을 설정하며, **태스크 세트** 단위로 교체됩니다.
> 4. 모든 서비스에서 **CloudWatch 알람을 통한 자동 롤백**이 가능합니다.