# ☁️ AWS CloudFormation 핵심 정리

CloudFormation은 **IaC(Infrastructure as Code)** 개념을 구현하는 서비스로, 코드를 통해 인프라를 생성, 복제 및 관리할 수 있게 해줍니다. 이는 Elastic Beanstalk, Service Catalog, SAM의 기반이 되는 핵심 도구입니다.

---

## 1. 리소스 삭제 정책 (Deletion Policy)

스택을 삭제할 때 특정 리소스를 보존하거나 백업하기 위해 설정합니다.

| 정책 | 내용 | 비고 |
| --- | --- | --- |
| **Retain** | 스택 삭제 시 리소스를 삭제하지 않고 그대로 남겨둠. | 모든 리소스 및 중첩 스택에 적용 가능 |
| **Snapshot** | 삭제 직전 리소스의 스냅샷을 생성함. | EBS, RDS, ElastiCache, Redshift 등 지원 |
| **Delete** | 기본값. 스택과 함께 리소스를 삭제함. | **RDS DB 클러스터**의 기본값은 Snapshot임 |

> [!CAUTION]
> **S3 버킷 주의사항:** 버킷 내부에 객체(데이터)가 비어있지 않으면 CloudFormation을 통한 삭제가 실패합니다.

---

## 2. 사용자 정의 리소스 (Custom Resources)

CloudFormation이 직접 지원하지 않는 작업이나 복잡한 로직을 처리할 때 **Lambda 함수**를 호출하여 해결합니다.

* **주요 유스케이스:**
  * CloudFormation 미지원 서비스 사용
  * 온프레미스 리소스 관리
  * S3 버킷 삭제 전 내부 비우기
  * 최신 AMI ID 동적 가져오기

* **작동 방식:** 스택의 생성·업데이트·삭제 이벤트 발생 시 Lambda를 호출하여 API를 실행합니다.

---

## 3. 스택 세트 (StackSets)

단일 작업으로 **여러 계정(Multi-Account)** 및 **여러 리전(Multi-Region)**에 걸쳐 스택을 관리합니다.

* **관리자 계정:** 스택 세트를 생성하고 제어하는 계정.
* **신뢰 대상(Target) 계정:** 실제 리소스가 배포되는 계정.
* **자동 배포:** AWS Organizations와 연동하여 **새 계정이 추가될 때** 필요한 인프라를 자동으로 프로비저닝할 수 있습니다.

---

## 4. 드리프트 감지 (Drift Detection)

CloudFormation을 통하지 않고 **수동으로 변경된 설정**을 감지하는 기능입니다.

* **동작:** 템플릿에 정의된 구성과 실제 실행 중인 리소스의 구성을 비교합니다.
* **범위:** 스택 전체 또는 개별 리소스 단위로 감지가 가능합니다.

---

## 5. Secrets Manager 통합 및 로테이션

비밀번호와 같은 민감한 정보를 안전하게 관리하고 리소스에 주입합니다.

1. **Secret 생성:** Secrets Manager를 통해 암호 생성.
2. **참조 및 주입:** `!Sub` 함수 등을 사용하여 RDS 등에 시크릿 전달.
3. **연결(TargetAttachment):** `SecretTargetAttachment` 리소스를 생성하여 시크릿과 DB를 연결.
   * 이 설정을 통해 **시크릿이 로테이션(변경)**될 때 DB 비밀번호도 자동으로 동기화됩니다.



---

## 6. 리소스 가져오기 (Resource Import)

기존에 수동으로 생성했던 AWS 리소스를 삭제하지 않고 **CloudFormation 스택의 관리 대상으로 편입**시키는 기능입니다.

* **특징:** 리소스를 삭제하고 다시 생성할 필요가 없습니다.
* **필수 조건:**
  * 대상 리소스를 정확히 묘사하는 템플릿 작성 필요.
  * 각 리소스의 **고유 식별자**(예: S3 버킷 명)를 명시해야 함.
  * 동일한 리소스를 여러 스택으로 중복해서 가져올 수 없음.