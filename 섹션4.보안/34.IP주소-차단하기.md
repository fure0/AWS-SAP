## 🛡️ AWS 네트워크 보안: 아키텍처별 IP 차단 및 방어 전략

클라이언트(잠재적 악의적 행위자)의 요청이 애플리케이션에 도달하기까지, 각 단계에서 활용할 수 있는 방어선(Line of Defense)을 이해하는 것이 중요합니다.

### 1. 기본 구조: EC2 단일 인스턴스 환경

인스턴스가 공용 IP를 가지고 VPC 내에 직접 노출된 경우입니다.

* **1단계: 네트워크 ACL (NACL)**
* **특징:** VPC 수준의 방어선. Stateless(상태 비저장).
* **장점:** 특정 IP에 대해 **'거부(Deny)' 규칙**을 생성할 수 있음. 빠르고 저렴함.
* **역할:** 악의적인 IP가 VPC 내부로 들어오기 전에 즉시 차단.


* **2단계: 보안 그룹 (Security Group)**
* **특징:** 인스턴스 수준의 방어선. Stateful(상태 저장).
* **한계:** **'허용(Allow)' 규칙만 가능**하며, 특정 IP를 개별적으로 '거부'할 수 없음.
* **용도:** 신뢰할 수 있는 특정 IP 범위만 접속 허용 시 유리. (글로벌 서비스 시에는 활용도가 낮음)


* **3단계: 호스트 OS 방화벽 (Host Firewall)**
* **특징:** EC2 내부 소프트웨어(iptables 등)를 이용한 차단.
* **단점:** 트래픽이 이미 인스턴스에 도달했으므로, 차단 과정에서 **CPU 자원을 소모**함.



---

### 2. 로드 밸런서 도입 환경: Application Load Balancer (ALB)

ALB가 클라이언트와 EC2 사이에서 '연결 종료(Connection Termination)'를 수행하는 구조입니다.

* **연결 구조:** 클라이언트 ↔ ALB(Public) ↔ EC2(Private).
* **보안 그룹 설정:**
* **ALB 보안 그룹:** 클라이언트(0.0.0.0/0 또는 특정 범위)의 트래픽 허용.
* **EC2 보안 그룹:** **ALB의 보안 그룹 ID**로부터 오는 트래픽만 허용하도록 설정 (가장 안전한 방식).


* **IP 차단 전략:**
* **NACL:** 여전히 VPC 경계에서 특정 IP 차단 가능.
* **WAF (Web Application Firewall):**
* ALB에 직접 배포하는 유료 보안 서비스.
* **고급 필터링:** 복잡한 조건의 IP 차단 및 **요청 개수 제한(Rate Limiting)** 가능.
* 애플리케이션 계층(L7) 공격 방어에 최적화.





---

### 3. 글로벌 서비스 환경: CloudFront 도입

VPC 외부의 에지 로케이션(Edge Location)에서 캐싱 서비스를 제공하는 경우입니다.

* **트래픽 흐름:** 클라이언트 → CloudFront ↔ ALB ↔ EC2.
* **주의사항:** ALB 입장에서의 소스 IP는 클라이언트가 아닌 **CloudFront의 공용 IP**가 됩니다.
* **차단 전략의 변화:**
* **NACL 사용 불가:** 클라이언트 IP가 아닌 CloudFront IP가 찍히므로, NACL에서 클라이언트 IP를 차단하는 것은 효과가 없음.
* **CloudFront 지리적 제한 (Geo-Restriction):** 특정 국가로부터의 공격인 경우, 국가 단위로 접속 차단 가능.
* **CloudFront 기반 WAF:** CloudFront 배포 지점에 WAF를 설치하여 특정 IP나 공격 패턴을 에지 수준에서 차단.



---

### 📋 방어 수단 요약 비교

| 방어 수단 | 위치 | 주요 기능 | 특징 |
| --- | --- | --- | --- |
| **NACL** | VPC/Subnet | IP 거부(Deny) | 가장 빠르고 저렴함, 상태 비저장 |
| **보안 그룹** | 인스턴스/ENI | IP 허용(Allow) | 거부 규칙 생성 불가, 상태 저장 |
| **WAF** | ALB / CloudFront | L7 필터링, Rate Limit | 정교한 제어 가능, 추가 비용 발생 |
| **Geo-Restriction** | CloudFront | 국가별 차단 | 특정 국가 전체 접근 제어에 유용 |
| **호스트 방화벽** | EC2 OS 내부 | 내부 소프트웨어 차단 | 인스턴스 자원(CPU) 소모 |

---

**💡 핵심 요약:**
아키텍처에 따라 IP가 보이는 지점이 다릅니다. 직접 연결 시에는 **NACL**이 효율적이지만, CloudFront 같은 글로벌 서비스 이용 시에는 **WAF**나 **CloudFront 자체 기능**을 사용하여 방어선을 구축해야 합니다.