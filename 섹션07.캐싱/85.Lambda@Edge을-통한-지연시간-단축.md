## 🚀 Lambda@Edge를 활용한 멀티 오리진 라우팅 및 대기 시간 단축

이 아키텍처는 CloudFront 캐시에 데이터가 없는 **최초 요청(Cache Miss)** 시, 오리진(S3)으로부터 데이터를 가져오는 과정에서 발생하는 지연 시간(Latency)을 최소화하는 것이 핵심입니다.

### 1. 기존 방식의 문제점

* **시나리오:** 오리진 S3 버킷이 **미국 동부(us-east-1)**에 있고, 사용자가 **유럽**에 있는 경우.
* **문제:** 캐시된 데이터가 없다면 유럽의 엣지 로케이션은 미국 오리진까지 요청을 보내야 합니다. 이 과정에서 지리적 거리로 인해 상당한 **대기 시간(Latency)**이 발생합니다.

### 2. 최적화 해결책: 멀티 리전 S3 & Lambda@Edge

이 문제를 해결하기 위해 **S3 교차 리전 복제(CRR)**와 **Lambda@Edge**를 결합하여 사용합니다.

#### **A. 데이터 복제 (S3 Cross-Region Replication)**

* 유럽(예: 런던 리전)에 두 번째 S3 버킷을 생성합니다.
* **S3 CRR**을 설정하여 미국 버킷의 모든 콘텐츠를 유럽 버킷으로 실시간 복제합니다.
* 결과적으로 양쪽 리전에 동일한 데이터가 존재하게 됩니다.

#### **B. 지능적 라우팅 (Lambda@Edge)**

CloudFront의 **오리진 요청(Origin Request)** 이벤트에 Lambda@Edge 함수를 배치합니다.

1. **사용자 요청:** 사용자가 엣지 로케이션에 접속합니다.
2. **함수 트리거:** Lambda@Edge가 실행되어 사용자의 접속 위치(리전)를 파악합니다.
3. **오리진 변경:**
   * 사용자가 미국 근처라면? → **미국 S3 버킷**으로 라우팅.
   * 사용자가 유럽 근처라면? → **유럽 S3 버킷**으로 오리진 요청 주소를 수정.

4. **결과:** 엣지 로케이션과 가장 가까운 오리진에서 데이터를 가져오므로 **최초 호출 대기 시간이 획기적으로 줄어듭니다.**

---

### 3. 아키텍처 요약 및 장점

| 구성 요소 | 역할 |
| --- | --- |
| **CloudFront** | 전 세계 사용자에게 콘텐츠 전송 및 캐싱 |
| **S3 CRR** | 리전 간 데이터 동기화 유지 (데이터 무결성) |
| **Lambda@Edge** | 사용자 위치에 기반하여 **동적으로 오리진(Origin)을 선택** |

> **💡 핵심 요약**
> 이 패턴은 단순 캐싱을 넘어, **캐시 미스 발생 시에도 최적의 경로를 보장**하기 위해 사용됩니다. 설정은 다소 복잡하지만, 글로벌 서비스에서 사용자 경험(UX)을 극대화하는 데 매우 효과적인 AWS SAP 수준의 설계 패턴입니다.