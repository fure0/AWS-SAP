# ☁️ AWS CloudWatch Logs 핵심 요약 (SAP 대비)

CloudWatch Logs는 단순한 로그 저장소가 아니라, AWS 에코시스템 전반의 데이터를 수집, 분석 및 전송하는 핵심 서비스입니다.

---

## 1. 로그 데이터 수집 (Ingestion)

CloudWatch Logs로 데이터를 가져오는 방법은 크게 세 가지 범주로 나뉩니다.

### 1) 에이전트 및 SDK 활용

* **CloudWatch Logs 에이전트 / 통합 에이전트:** EC2 인스턴스뿐만 아니라 **온프레미스 VM**, 서버 어디든 설치 가능합니다.
* **SDK:** 애플리케이션 코드 내에서 직접 로그를 전송합니다.

### 2) AWS 서비스 통합 (Managed Services)

많은 AWS 서비스가 기본적으로 CloudWatch Logs와 연동됩니다.

* **Compute:** Elastic Beanstalk (앱 로그), ECS (로그 드라이버), Lambda (함수 로그)
* **Network/Security:** VPC Flow Logs, API Gateway, Route 53 (DNS 쿼리 로그), CloudTrail

---

## 2. CloudWatch Logs 구조 및 관리

* **로그 그룹 (Log Group):** 일반적으로 애플리케이션 단위로 이름을 지정합니다.
* **로그 스트림 (Log Stream):** 로그 그룹 내에서 개별 인스턴스, 로그 파일, 컨테이너 등을 구분하는 단위입니다.
* **만료 정책 (Retention Policy):** 로그를 영구 보관하거나 특정 기간(예: 30일) 후 자동 삭제되도록 설정할 수 있습니다. (장기 보관이 필요하면 외부 저장소로 내보내기 권장)
* **보안:** **KMS(Key Management Service)**를 통해 로그 데이터를 암호화할 수 있습니다.

---

## 3. 분석 및 시각화 (Filters & Insights)

로그 데이터를 활용해 실시간 모니터링이나 사후 분석을 수행합니다.

### 1) 지표 필터 (Metric Filters)

* **동작:** 로그 내 특정 패턴(예: "ERROR", "IP 주소")을 검색하여 수치화된 **지표(Metric)**로 변환합니다.
* **알람 연동:** 생성된 지표를 바탕으로 **CloudWatch Alarms**를 설정하여 자동화된 조치를 취할 수 있습니다.

### 2) CloudWatch Logs Insights

* 로그 데이터를 직접 쿼리(SQL-like)하여 분석하는 도구입니다.
* Lambda, Route 53, VPC Flow Logs 등을 위한 **샘플 쿼리**를 제공하며, 결과를 대시보드에 추가할 수 있습니다.

---

## 4. 로그 데이터 내보내기 (Export) 및 전송

| 방식 | 특징 | 주요 용도 |
| --- | --- | --- |
| **S3 내보내기** | **비실시간** (최대 12시간 지연), `CreateExportTask` API 사용 | 장기 보관, 비용 효율적인 대량 분석 |
| **구독 필터 (Lambda)** | **실시간**, 커스텀 로직 실행 가능 | 실시간 분석, Elasticsearch(OpenSearch) 전송 |
| **구독 필터 (Firehose)** | **준실시간** (Near Real-time), 비용 효율적, 확장성 우수 | S3, Redshift, Splunk 등으로 자동 전송 |
| **구독 필터 (Kinesis)** | **실시간/고성능**, 샤딩을 통한 확장 | 복잡한 실시간 데이터 파이프라인 구성 |

> [!TIP]
> **Lambda vs Firehose 선택 기준:**
> 아주 짧은 지연 시간의 실시간성이 최우선이라면 **Lambda**, 1분 정도의 지연을 허용하면서 비용 효율성과 확장성을 중시한다면 **Kinesis Data Firehose**가 정답입니다.

---

## 5. 고급 아키텍처: 다중 계정/리전 로그 집계

엔터프라이즈 환경에서는 여러 계정과 리전의 로그를 하나로 모으는 것이 중요합니다.

1. **각 계정/리전:** CloudWatch Logs 설정 + **구독 필터(Subscription Filter)** 생성.
2. **전송:** 중앙 로그 계정의 **Kinesis Data Streams**로 로그 전송.
3. **집계:** Kinesis Data Firehose를 통해 중앙 보안/로깅 계정의 **S3** 등에 최종 저장.

---

## 6. CloudWatch 에이전트 배포 (SSM 통합)

Systems Manager(SSM)를 사용하면 대규모 EC2 환경에서 에이전트 관리가 수월해집니다.

* **방법 1 (Run Command):** `ConfigureAWSPackage` 명령과 `AmazonCloudWatchAgent` 패키지명을 사용하여 즉시 설치.
* **방법 2 (State Manager):** 인스턴스 상태를 정의하여 자동으로 설치 및 업데이트 유지.
* **방법 3 (Parameter Store):** 에이전트 설정 파일(JSON)을 SSM Parameter Store에 저장하고, 에이전트가 시작될 때 이를 다운로드하여 구성하도록 설정.
